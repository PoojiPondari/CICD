name: Zephyr Firmware CI

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ZEPHYR_TOOLCHAIN_VARIANT: zephyr
      ZEPHYR_SDK_INSTALL_DIR: ${{ github.workspace }}/zephyr-sdk
      QEMU_BIN_PATH: /usr/bin

    steps:
    - name: ⬇️ Checkout repository
      uses: actions/checkout@v4

    - name: 🛠️ Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y cmake ninja-build gperf ccache dfu-util device-tree-compiler wget \
          python3-pip git python3-setuptools python3-wheel xz-utils file make gcc \
          qemu-system-arm
        pip3 install west

    - name: 📦 Install Zephyr SDK
      run: |
        wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.3/zephyr-sdk-0.16.3_linux-x86_64.tar.xz
        tar -xf zephyr-sdk-0.16.3_linux-x86_64.tar.xz
        mv zephyr-sdk-0.16.3 $ZEPHYR_SDK_INSTALL_DIR
        $ZEPHYR_SDK_INSTALL_DIR/setup.sh -t all -c
    
    - name: 🔍 List repo structure for debug
      run: ls -R
    
    - name: 🔧 Build Zephyr Firmware
      working-directory: zephyrproject
      run: |
        west update
        west zephyr-export
        west build -b qemu_cortex_m3 zephyr/samples/hello_world --pristine

    - name: 🚀 Run Firmware in QEMU
      working-directory: zephyrproject
      run: |
        west build -t run

    - name: 🧾 Generate SBOM, hash, metadata
      working-directory: zephyrproject
      run: |
        mkdir -p metadata
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b . v0.100.0
        ./syft dir:build/zephyr --output spdx-json > metadata/firmware.spdx.json
        sha256sum build/zephyr/zephyr.elf > metadata/firmware.sha256
        echo "{\"git_sha\": \"$(git rev-parse --short HEAD)\", \"build_time\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"}" > metadata/build_metadata.json

    - name: 📤 Upload Firmware Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zephyr-artifacts
        path: |
          zephyrproject/build/zephyr/zephyr.elf
          zephyrproject/metadata/build_metadata.json
          zephyrproject/metadata/firmware.spdx.json
          zephyrproject/metadata/firmware.sha256
